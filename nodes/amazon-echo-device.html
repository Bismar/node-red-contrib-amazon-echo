<script type="text/html" data-template-name="amazon-echo-device-ha-entities">
  <div class="form-row">
    <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
    <input type="text" id="node-input-name" placeholder="Amazon Echo Device (HA)">
  </div>

  <!-- Visible & required: HA server config node -->
  <div class="form-row" id="ha-server-row">
    <label for="node-input-haServer"><i class="fa fa-plug"></i> Home Assistant server</label>
    <input type="text" id="node-input-haServer">
  </div>

  <div class="form-row">
    <label for="node-input-haDeviceId"><i class="fa fa-cubes"></i> Device Name</label>
    <select id="node-input-haDeviceId" style="width:100%"></select>
  </div>

  <div class="form-row">
    <label for="node-input-haEntityId"><i class="fa fa-dot-circle-o"></i> Entity Name</label>
    <select id="node-input-haEntityId" style="width:100%"></select>
  </div>
</script>

<script type="text/html" data-help-name="amazon-echo-device-ha-entities">
  <p>Link an Amazon Echo device with a Home Assistant Device & Entity.</p>
  <ul>
    <li><b>Home Assistant server</b> — select your HA websocket config node.</li>
    <li><b>Device Name</b> — optional filter; limits the Entity list.</li>
    <li><b>Entity Name</b> — required; the HA entity id to associate.</li>
  </ul>
</script>

<script type="text/javascript">
(function () {
  RED.nodes.registerType("amazon-echo-device-ha-entities", {
    category: "amazon",
    color: "#FFD580",
    icon: "amazon-echo-device.svg",
    inputs: 1,
    outputs: 1,
    align: "right",
    paletteLabel: "amazon echo device (HA)",
    defaults: {
      name:       { value: "" },
      haServer:   { value: "", type: "server", required: true },
      haDeviceId: { value: "" },
      haEntityId: { value: "" }
    },
    label: function () {
      return this.name || "Amazon Echo Device (HA)";
    },
    oneditprepare: function () {
      const $server = $("#node-input-haServer");
      const $device = $("#node-input-haDeviceId");
      const $entity = $("#node-input-haEntityId");

      function reset() {
        $device.empty().append($("<option/>",{value:"",text:"(All devices)"})).prop("disabled", false);
        $entity.empty().append($("<option/>",{value:"",text:"Select entity..."})).prop("disabled", true);
      }
      reset();

      function loadDevices(serverId, selectedDeviceId) {
        if (!serverId) {
          reset();
          return;
        }
        $device.prop("disabled", false).empty().append($("<option/>",{value:"",text:"(All devices)"}));
        $.getJSON("amazon-echo-ha-entities/devices", { server: serverId })
          .done(function (devices) {
            devices.forEach(function (d) {
              $device.append($("<option/>", { value: d.id, text: d.displayName || d.name || d.id }));
            });
            if (selectedDeviceId) $device.val(selectedDeviceId);
            $device.trigger("change");
          })
          .fail(function (xhr) {
            reset();
            RED.notify("Failed to load devices: " + (xhr.responseText || xhr.statusText), "error");
          });
      }

      function loadEntities(serverId, deviceId, selectedEntityId) {
        if (!serverId) return;
        $entity.prop("disabled", true).empty().append($("<option/>",{value:"",text:"Loading entities..."}));
        const query = { server: serverId };
        if (deviceId) query.device = deviceId;
        $.getJSON("amazon-echo-ha-entities/entities", query)
          .done(function (entities) {
            $entity.empty().append($("<option/>",{value:"",text:"Select entity..."}));
            entities.forEach(function (e) {
              const label = e.displayName || e.name || e.entity_id;
              $entity.append($("<option/>",{ value: e.entity_id, text: label }));
            });
            if (selectedEntityId) $entity.val(selectedEntityId);
            $entity.prop("disabled", false);
          })
          .fail(function (xhr) {
            $entity.empty().append($("<option/>",{value:"",text:"(failed to load)"}));
            RED.notify("Failed to load entities: " + (xhr.responseText || xhr.statusText), "error");
          });
      }

      $server.on("change", function(){
        loadDevices($server.val(), $("#node-input-haDeviceId").val());
      });

      $device.on("change", function(){
        loadEntities($server.val(), $device.val(), $("#node-input-haEntityId").val());
      });

      const initialServer = $server.val();
      if (initialServer) {
        loadDevices(initialServer, $("#node-input-haDeviceId").val());
      }
    }
  });
})();
</script>
