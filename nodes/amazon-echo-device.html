<!-- nodes/amazon-echo-device.html -->
<script type="text/html" data-template-name="amazon-echo-device-ha-entities">
  <div class="amazon-echo-device-ha-entities-config">
    <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
      <input type="text" id="node-input-name" placeholder="Amazon Echo Device (HA)">
    </div>

    <!-- Required: HA server config node -->
    <div class="form-row" id="ha-server-row">
      <label for="node-input-haServer"><i class="fa fa-plug"></i> Home Assistant server</label>
      <input type="text" id="node-input-haServer">
    </div>

    <!-- Filters BEFORE device selection -->
    <div class="form-row">
      <label for="node-input-haAreaId"><i class="fa fa-building"></i> Area</label>
      <select id="node-input-haAreaId" style="width:100%"></select>
      <div class="form-tips" id="ha-area-count" style="margin-top:2px;"></div>
    </div>

    <div class="form-row">
      <label for="node-input-haLabelId"><i class="fa fa-tag"></i> Label</label>
      <select id="node-input-haLabelId" style="width:100%"></select>
      <div class="form-tips" id="ha-label-count" style="margin-top:2px;"></div>
    </div>

    <div class="form-row">
      <!-- prevent wrapping without changing text -->
      <label for="node-input-haDomain" class="nowrap"><i class="fa fa-cube"></i> Component type</label>
      <select id="node-input-haDomain" style="width:100%"></select>
      <div class="form-tips" id="ha-domain-count" style="margin-top:2px;"></div>
    </div>

    <div class="form-row">
      <label for="node-input-haDeviceId"><i class="fa fa-cubes"></i> Device</label>
      <select id="node-input-haDeviceId" style="width:100%"></select>
      <div class="form-tips" id="ha-device-count" style="margin-top:2px;"></div>
    </div>

    <div class="form-row">
      <label for="node-input-haEntityId"><i class="fa fa-dot-circle-o"></i> Entity</label>
      <select id="node-input-haEntityId" style="width:100%"></select>
    </div>

    <!-- Live hint with the raw entity_id -->
    <div class="form-tips" id="ha-entity-hint" style="margin-top:4px;"></div>

    <!-- Modes & attributes preview -->
    <div class="form-row" id="ha-entity-modes-row" style="display:none;">
      <label><i class="fa fa-sliders"></i> Available modes</label>
      <div id="ha-entity-modes" class="form-tips"></div>
    </div>

    <div class="form-row" id="ha-entity-attrs-row" style="display:none;">
      <label><i class="fa fa-list"></i> Attributes</label>
      <pre id="ha-entity-attrs" style="max-height:240px; overflow:auto; background:#f7f7f7; border:1px solid #ddd; padding:6px; border-radius:3px;"></pre>
    </div>
  </div>
</script>

<script type="text/html" data-help-name="amazon-echo-device-ha-entities">
  <p>Link an Amazon Echo device with a Home Assistant Device &amp; Entity.</p>
  <ul>
    <li>Pre-filter by <b>Area</b>, <b>Label</b>, and <b>Component type</b> (domain), with counts showing total devices and how many are filtered out.</li>
    <li>Pick a <b>Device</b> and then an <b>Entity</b>. The selected <code>entity_id</code> and its modes/attributes are shown below.</li>
  </ul>
</script>

<script type="text/javascript">
(function () {
  RED.nodes.registerType("amazon-echo-device-ha-entities", {
    category: "amazon",
    color: "#FFD580",
    icon: "amazon-echo-device.svg",
    inputs: 1,
    outputs: 1,
    align: "right",
    paletteLabel: "amazon echo device (HA)",
    defaults: {
      name:       { value: "" },
      haServer:   { value: "", type: "server", required: true },
      haAreaId:   { value: "" },   // new
      haLabelId:  { value: "" },   // new
      haDomain:   { value: "" },   // new
      haDeviceId: { value: "" },
      haEntityId: { value: "" }
    },
    label: function () {
      return this.name || "Amazon Echo Device (HA)";
    },
    oneditprepare: function () {
      const $server = $("#node-input-haServer");
      const $area   = $("#node-input-haAreaId");
      const $label  = $("#node-input-haLabelId");
      const $domain = $("#node-input-haDomain");
      const $device = $("#node-input-haDeviceId");
      const $entity = $("#node-input-haEntityId");

      const $areaCount   = $("#ha-area-count");
      const $labelCount  = $("#ha-label-count");
      const $domainCount = $("#ha-domain-count");
      const $deviceCount = $("#ha-device-count");

      const $hint   = $("#ha-entity-hint");
      const $modesRow = $("#ha-entity-modes-row");
      const $modes    = $("#ha-entity-modes");
      const $attrsRow = $("#ha-entity-attrs-row");
      const $attrs    = $("#ha-entity-attrs");

      let TOTAL_DEVICES = 0;

      function setEntityHint() {
        const eid = $entity.val() || "";
        $hint.text(eid ? ("Selected entity_id: " + eid) : "");
      }

      function showEntityInfo(info) {
        if (!info || !info.entity_id) {
          $modesRow.hide(); $attrsRow.hide(); $modes.empty(); $attrs.text("");
          return;
        }
        const dm = info.detected_modes || {};
        const keys = Object.keys(dm).filter(k => Array.isArray(dm[k]) && dm[k].length);
        if (keys.length) {
          const frag = document.createDocumentFragment();
          keys.forEach(k => {
            const group = document.createElement("div");
            group.style.marginBottom = "4px";
            const title = document.createElement("div");
            title.style.fontWeight = "600";
            title.textContent = k;
            group.appendChild(title);
            dm[k].forEach(v => {
              const pill = document.createElement("span");
              pill.textContent = v;
              pill.style.display = "inline-block";
              pill.style.padding = "2px 6px";
              pill.style.margin = "2px 6px 0 0";
              pill.style.border = "1px solid #bbb";
              pill.style.borderRadius = "999px";
              pill.style.background = "#fff";
              group.appendChild(pill);
            });
            frag.appendChild(group);
          });
          $modes.empty().append(frag);
          $modesRow.show();
        } else {
          $modes.empty(); $modesRow.hide();
        }

        if (info.attributes && typeof info.attributes === "object") {
          try { $attrs.text(JSON.stringify(info.attributes, null, 2)); }
          catch (e) { $attrs.text(String(info.attributes)); }
          $attrsRow.show();
        } else {
          $attrs.text(""); $attrsRow.hide();
        }
      }

      function setCounts(filteredDevicesCount) {
        const filteredOut = Math.max(0, TOTAL_DEVICES - filteredDevicesCount);
        const labelText = (x,y) => `${x} available, ${y} filtered`;
        $areaCount.text(labelText(TOTAL_DEVICES, filteredOut));
        $labelCount.text(labelText(TOTAL_DEVICES, filteredOut));
        $domainCount.text(labelText(TOTAL_DEVICES, filteredOut));
        $deviceCount.text(labelText(TOTAL_DEVICES, filteredOut));
      }

      function resetSelect($sel, firstText) {
        $sel.empty().append($("<option/>",{value:"",text:firstText}));
      }

      function resetAll() {
        resetSelect($area,   "(All areas)");
        resetSelect($label,  "(All labels)");
        resetSelect($domain, "(All component types)");
        resetSelect($device, "(Select device)");
        resetSelect($entity, "(Select entity)");
        $entity.prop("disabled", true);
        setEntityHint();
        showEntityInfo(null);
        setCounts(0);
      }
      resetAll();

      // Pick first available server as default (without touching DOM structure)
      function pickDefaultServerOnce() {
        try {
          if ($server.val()) return; // already set (editing)
          const $sel = $("#ha-server-row .input-append select");
          if (!$sel.length) return;   // not rendered yet
          const opts = $sel[0].options || [];
          if (!opts.length) return;
          // Prefer first non-empty value
          let firstVal = "";
          for (let i=0; i<opts.length; i++) {
            if (opts[i].value) { firstVal = opts[i].value; break; }
          }
          if (!firstVal) firstVal = opts[0].value || "";
          if (firstVal) {
            $sel.val(firstVal).trigger("change");
            $server.val(firstVal); // keep the hidden value in sync
          }
        } catch(e) { /* swallow */ }
      }
      // Try immediately and once more after a short delay to catch async render
      setTimeout(pickDefaultServerOnce, 0);
      setTimeout(pickDefaultServerOnce, 100);

      // Wire events
      $server.on("change", function(){ loadFilters($server.val()); });
      $area.on("change",   function(){
        $("#node-input-haAreaId").val($area.val());
        loadDevices($server.val(), $area.val(), $label.val(), $domain.val(), $("#node-input-haDeviceId").val());
      });
      $label.on("change",  function(){
        $("#node-input-haLabelId").val($label.val());
        loadDevices($server.val(), $area.val(), $label.val(), $domain.val(), $("#node-input-haDeviceId").val());
      });
      $domain.on("change", function(){
        $("#node-input-haDomain").val($domain.val());
        loadDevices($server.val(), $area.val(), $label.val(), $domain.val(), $("#node-input-haDeviceId").val());
      });
      $device.on("change", function(){
        loadEntities($server.val(), $device.val(), $("#node-input-haEntityId").val());
      });
      $entity.on("change", function(){
        setEntityHint();
        loadEntityInfo($server.val(), $entity.val());
      });

      // Initial populate (edit existing node)
      const initialServer = $server.val();
      if (initialServer) {
        loadFilters(initialServer);
      } else {
        resetAll();
      }
    }
  });
})();
</script>

<!-- LAYOUT-ONLY (scoped) -->
<style>
  :root {
    --aehe-label-w: 180px; /* tweak if labels truncate */
    --aehe-gap: 10px;
  }

  /* keep “Component type” on one line */
  .amazon-echo-device-ha-entities-config label.nowrap { white-space: nowrap; }

  /* Two-column grid per row: fixed label + flexible field */
  .amazon-echo-device-ha-entities-config .form-row {
    display: grid;
    grid-template-columns: var(--aehe-label-w) 1fr;
    column-gap: var(--aehe-gap);
    align-items: center;
  }
  .amazon-echo-device-ha-entities-config .form-row > label { grid-column: 1; }
  .amazon-echo-device-ha-entities-config .form-row > input[type="text"],
  .amazon-echo-device-ha-entities-config .form-row > select,
  .amazon-echo-device-ha-entities-config .form-row > .red-ui-typedInput,
  .amazon-echo-device-ha-entities-config .form-row > .input-append {
    grid-column: 2;
    width: 100% !important;
    max-width: 100%;
    box-sizing: border-box;
  }

  /* Server row: make input-append a flex row so the select stretches.
     Buttons remain siblings, but we push the FIRST button to the right. */
  .amazon-echo-device-ha-entities-config #ha-server-row .input-append {
    display: flex;
    align-items: stretch;
    width: 100%;
    gap: 6px;
  }
  .amazon-echo-device-ha-entities-config #ha-server-row .input-append > select,
  .amazon-echo-device-ha-entities-config #ha-server-row .input-append > .red-ui-typedInput,
  .amazon-echo-device-ha-entities-config #ha-server-row .input-append > input[type="text"] {
    flex: 1 1 auto;      /* fills remaining space */
    min-width: 0;
  }
  /* Push the first control AFTER the select (a button/link) to the right edge */
  .amazon-echo-device-ha-entities-config #ha-server-row .input-append > select + * {
    margin-left: auto;
  }

  /* Tips (yellow count blocks) align under the field (right column) */
  .amazon-echo-device-ha-entities-config .form-row > .form-tips { grid-column: 2; }

  /* Standalone tips line up with column 2 as well */
  .amazon-echo-device-ha-entities-config > .form-tips {
    margin-left: calc(var(--aehe-label-w) + var(--aehe-gap));
  }
</style>
